# PKU-PTA 指针分析项目报告

## 成员及分工
- 安昱达 2000017737：整体逻辑讨论、基础框架逻辑及类型搭建、全局控制流图构建、debug
- 孙英博 2000017736：整体逻辑讨论、数据流迭代分析实现、debug
- 杜思娴 2000017403：整体逻辑讨论、数据流基本块内部逻辑实现与分析、debug

## 1. 数据结构和全局变量

### 1.1 数据结构

- **`PtrID`**: 代表程序中的指针标识。
- **`PtrList`**: 包含所有指针的集合，支持从变量、静态字段和实例字段到指针ID的映射。
- **`PtrCopy`**: 描述 `PtrList` 中指针间的拷贝关系。
- **`BB` (基本块)**: 包含拷贝操作序列和 `NewLoc`。
- **`CFG` (控制流图)**: 描述程序流程结构的图，包括基本块、入口和出口。
- **`NewLoc`**: 记录指针分配位置的结构。`HashMap<Integer, TreeSet<Integer>> obj` : 表示指针 `a` 可能在 `[1,2,...]` 处分配。第一个 `Integer` 是指针 ID，第二个是 `Benchmark.alloc` 的位置。

### 1.2 全局变量

- **`glbPtrList`**: 全局指针列表，用于追踪程序中的所有指针。
- **`glbCFG`**: 全局控制流图，展现整个程序的流程。
- **`initial`**: 初始新位置信息，作为数据流分析的起点。

## 2. 指针分析算法

### 2.1 构建全局控制流图 (CFG)

- **`buildCFGEdges`**: 
   - 从 IR 开始，为每个方法构建控制流图的边。其中方法调用会在下一条语句形成新的 BB。
   - 处理方法调用。在 `recv = Invoke(base, args)` 语句处，构造两个连接用的 BB ：`call=[this=base, param0=arg0, ...]`, `ret=[base=this, arg0=param0, ...]` 。
   - 递归处理各个调用，在调用之间通过 `call` 和 `ret` 连接。在被调用方法的每个 `Return(r)` 语句处还要加上 `recv=r`。

### 2.2 数据流分析

- **`dataflowAnalyze`**: 
   - 对全局CFG执行数据流分析。
   - 初始状态下，将所有基本块的输出状态设为初始 `NewLoc` 信息。
   - 通过迭代更新，直至达到数据流分析的稳定状态。
   - 分析每个基本块的输入和输出状态，更新 `NewLoc` 信息。

### 2.3 指针关系分析

* **`BBsFromInvoke`**
  * 对每个方法调用，创建调用前后的基本块，处理参数传递和返回值接收。
  * 调用函数时，显示增加 `param=arg` 关系，返回时增加 `arg=param` 关系。
  * 在类方法内部开始时增加 `this=a`（a为类的实例），结束时增加 `a=this` 关系。
  * 关于返回值的处理在各 BB 内部 （参见 `buildCFGEdges`）。

- **`analyzeBB`**: 
   - 对每个基本块中的IR语句进行遍历。
   - 对每种指针操作（如赋值、字段加载和存储）创建拷贝关系。
   - 通过语句顺序确定拷贝关系的优先级，处理重叠和覆盖的情况。
   - 在遇到方法调用（`Invoke`）时，使用函数摘要来解析并更新拷贝关系。
   - 如果方法修改了不在 `ptrList` 中的内容，将其添加到 `ptrList` 中。
   - 在字段间传递拷贝关系，并且处理嵌套字段的情况。
   - 使用迭代方法传递所有拷贝关系，实现关系的完整覆盖。
- **`BB`**:
   - 存储基本块内的指令序列和新位置信息，处理指令间的拷贝关系，计算基本块的输出状态。
   - 对于语句中的复制关系将隐式关系加入到复制关系中。
   - 根据语句生成 `kill` 集合，合并输入关系 `IN` ，根据语句逻辑生成输出关系 `OUT` 。


### 2.4 结果记录与输出

- **`analyze`**:
   - 分析程序的主要入口。
   - 预处理阶段，获取所有方法的IR并初始化全局 CFG。
   - 构建全局指针列表和控制流图。
   - 执行数据流分析，计算每个指针的新位置信息。
   - 根据测试 ID 收集分析结果，并输出到指定文件。

